<script>
    let eventData;
    const postData = {};

    async function getEventData(eventID) {
        const sourceParts = window.location.href.split('/');
        const url = sourceParts[0] + '//' + sourceParts[2] + "/api/event/" + eventID;
        const res = await fetch(url);

        if (res.status != 200) {
            return;
        }
        const data = await res.json();
        return data;
    }

    function populateData(eventData) {
        document.getElementById("booking_modal_image").src = eventData.main_image_url;
        document.getElementById("booking_modal_title").textContent = eventData.title;
        document.getElementById("booking_modal_description").textContent = eventData.description;
        document.getElementById("booking_modal_location").textContent = eventData.location_name;
        document.getElementById("booking_modal_date").textContent = eventData.date_description;

        const select = document.getElementById("ticket_type_select");
        select.innerHTML = "";
        for (let i = 0; i<eventData.ticket_types.length; i++) {
            let option = document.createElement('option');
            option.value = eventData.ticket_types[i].ticket_type_id;
            option.textContent = eventData.ticket_types[i].option_description;
            select.appendChild(option);
        }
    }

    function startLoading(loadingTag, contentTag) {
        loadingTag.style.display = 'flex';
        contentTag.style.display = 'none';
    }

    function stopLoading(loadingTag, contentTag) {
        loadingTag.style.display = 'none';
        contentTag.style.display = 'flex';
    }

    function showErrorMessage(message) {
        const errorWrapperTag = document.getElementById('booking_modal_error_wrapper');
        const errorMessageTag = document.getElementById('booking_modal_error_message');
        errorMessageTag.textContent = message;
        errorWrapperTag.style.display = "flex";
    }

    function closeErrorMessage() {
        const errorWrapperTag = document.getElementById('booking_modal_error_wrapper');
        const errorMessageTag = document.getElementById('booking_modal_error_message');
        errorMessageTag.textContent = "";
        errorWrapperTag.style.display = "none";
    }

    async function handleBookNow(eventID) {
        closeErrorMessage();
        let loadingTag = document.getElementById('booking_modal_loading');
        let contentTag = document.getElementById('booking_modal_content');

        // Start loading
        startLoading(loadingTag, contentTag);

        // Getting event data
        eventData = await getEventData(eventID);

        // Populating Booking Modal
        populateData(eventData);

        // Stop loading
        stopLoading(loadingTag, contentTag);
    }

    function handleDeliveryMethodPage() {
        const ticket_amount = document.getElementById('ticket_amount_entry_field').value;

        console.log('BRO')

        if (ticket_amount > 10) {
            showErrorMessage("You can only buy a maximum of 10 tickets.");
        }
        
    }

</script>
<style>
    .model_adjuster {
        width: 80vw;
        max-width: none;
        border-radius: 16px;
    }
    .modal_base {
        background-color: var(--base-primary);
        border: 1px solid var(--type-weak);
        border-radius: 16px;
    }
    .main_wrapper {
        display: none;
        flex-direction: row;
        gap: 32px;
        height: 100%;
        padding: 16px;
    }
    .img_wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        width: calc(40% - 16px);
        height: 100%;
        max-height: 500px;
        border-radius: 16px;
    }
    .img_wrapper img {
        flex-shrink: 0;
        min-width: 100%;
        min-height: 100%;
    }
    .info_and_button_wrapper {
        display: flex;
        width: calc(60% - 16px);
        height: 500px;
        max-height: 500px;
        min-width: 350px;
        flex-direction: column;
        justify-content: space-between;
        padding-right: 16px;
        padding-bottom: 16px;
    }
    .info_wrapper {
        display: flex;
        flex-direction: column;
        gap: 32px;
    }
    .lds-dual-ring {
        display: inline-block;
        width: 80px;
        height: 80px;
    }
    .lds-dual-ring:after {
        content: " ";
        display: block;
        width: 64px;
        height: 64px;
        margin: 8px;
        border-radius: 50%;
        border: 6px solid #fff;
        border-color: #fff transparent #fff transparent;
        animation: lds-dual-ring 1.2s linear infinite;
    }
    @keyframes lds-dual-ring {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
    #booking_modal_loading {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--base-primary);
        border-radius: 16px;
        height: 500px;
    }
    .bottom_wrapper {
        display: flex;
        flex-direction: row;
        align-items: flex-end;
    }
    .icon_and_text {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 16px;
    }
    .icon_info_wrapper {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .entry_fields_wrapper {
        display: flex;
        width: 100%;
        gap: 16px;
    }
    .entry_field_main_wrapper {
        display: flex;
        width: 200px;
        flex-direction: column;
        justify-content: flex-start;
    }
    .entry_field_description {
        display: flex;
    }
    .entry_field_body {
        padding: 8px 16px;
        border-radius: 8px;
        border: 0;
    }
    #booking_modal_error_wrapper {
        position: absolute;
        left: 0;
        bottom: 0;
        display: none;
        align-items: center;
        gap: 16px;
        padding: 8px 16px;
        background-color: var(--status-danger);
        color: var(--type-primary);
        border-radius: 0 16px 0 16px;
    }
</style>
<div
    class="modal fade"
    id="booking_modal"
    tabindex="-1"
>
    <div class="modal-dialog model_adjuster">
        <div class="modal-content model_adjuster">
            <div class="modal_base">
                <div id="booking_modal_error_wrapper">
                    <p class="icon_large">error</p>
                    <p id="booking_modal_error_message" class="p_light">Error message!</p>
                </div>
                {% include 'components/progress_points.html' with progress_data=progress_data%}
                <div id="booking_modal_loading">
                    <div class="lds-dual-ring"></div>
                </div>
                <div id="booking_modal_content" class="main_wrapper">
                    <div class="img_wrapper">
                        <img id="booking_modal_image" alt="event image">
                    </div>
                    <div class="info_and_button_wrapper">
                        <div class="info_wrapper">
                            <h1 id="booking_modal_title" class="h1_semibold" style="font-size: 64px"></h1>
                            <p id="booking_modal_description" class="p_light">Event Description</p>
                            
                            <div class="icon_info_wrapper">
                                <div class="icon_and_text">
                                    <p class="icon_large">pin_drop</p>
                                    <h3 id="booking_modal_location" class="h3_regular"></h3>
                                </div>
                                <div class="icon_and_text">
                                    <p class="icon_large">calendar_month</p>
                                    <h3 id="booking_modal_date" class="h3_regular"></h3>
                                </div>
                            </div>
                        </div>
                        <div class="bottom_wrapper">
                            <div class="entry_fields_wrapper">
                                <div class="entry_field_main_wrapper">
                                    <div class="entry_field_description">
                                        <p class="label_light">Ticket Type</p>
                                    </div>
                                    <select id="ticket_type_select" class="entry_field_body"></select>
                                </div>
                                <div class="entry_field_main_wrapper">
                                    <div class="entry_field_description">
                                        <p class="label_light">Ticket Quantity</p>
                                    </div>
                                    <input id="ticket_amount_entry_field" class="entry_field_body" type="number" min=1 max=10 value=1></input>
                                </div>
                            </div>
                            <div>
                                <button class="button_outlined" onclick="handleDeliveryMethodPage()">Continue</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>